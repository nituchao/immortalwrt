name: Build ImmortalWrt N305

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  TARGET: x86
  SUBTARGET: 64

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc-multilib \
            gettext \
            git \
            libncurses-dev \
            libssl-dev \
            python3 \
            python3-distutils \
            rsync \
            unzip \
            wget \
            zlib1g-dev \
            file

      - name: Update & install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate custom files (uci-defaults)
        run: |
          mkdir -p files/etc/uci-defaults

          cat > files/etc/uci-defaults/99-custom-network << 'EOF'
          #!/bin/sh
          logger -t uci-defaults "Apply custom network (x86)"

          uci -q batch << 'EOT'
          delete network.lan
          delete network.wan
          delete network.wan6

          set network.lan_dev=device
          set network.lan_dev.name='br-lan'
          set network.lan_dev.type='bridge'

          set network.lan=interface
          set network.lan.device='br-lan'
          set network.lan.proto='static'
          set network.lan.ipaddr='192.168.100.1'
          set network.lan.netmask='255.255.255.0'
          set network.lan.ip6assign='60'

          set network.wan=interface
          set network.wan.device='eth0'
          set network.wan.proto='dhcp'
          EOT

          for p in eth1 eth2 eth3 eth4 enp2s0 enp3s0; do
            [ -e "/sys/class/net/$p" ] && \
              uci add_list network.lan_dev.ports="$p"
          done

          logger -t uci-defaults "Custom network done"
          exit 0
          EOF

          chmod +x files/etc/uci-defaults/99-custom-network

      - name: Generate .config
        run: |
          cat > .config << 'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y

          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
          CONFIG_PACKAGE_luci-theme-argon=y

          CONFIG_PACKAGE_openclash=y
          CONFIG_PACKAGE_smartdns=y
          CONFIG_PACKAGE_luci-app-smartdns=y
          CONFIG_PACKAGE_openlist=y
          CONFIG_PACKAGE_samba4-server=y
          CONFIG_PACKAGE_ttyd=y
          CONFIG_PACKAGE_filebrowser=y

          CONFIG_PACKAGE_kmod-tcp-bbr=y
          EOF

          make defconfig

      - name: Build firmware
        run: |
          make -j$(nproc) V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-x86_64-source
          path: |
            bin/targets/x86/64/*.img.gz
